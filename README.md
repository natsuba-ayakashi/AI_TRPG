# AI TRPG Fantasy

Discord上でAIゲームマスターと共に遊ぶ、テキストベースのTRPGボットです。
プレイヤーの行動によって世界がダイナミックに変化し、他のプレイヤーの冒険の痕跡があなたの物語に影響を与える、”生きている世界”を目指しています。

## ✨ 主な機能

### 冒険の準備
- **キャラクター作成 (`/character_create`)**:
  - 名前、種族、クラス、プロフィール（外見・背景）、能力値（ダイスロール）を対話形式で設定し、あなただけのキャラクターを作成できます。
- **キャラクター管理**:
  - `/status`: キャラクターシート（能力値、HP/MP、スキル、所持品など）を確認できます。
  - `/levelup`: 冒険で得た経験値（XP）を使い、能力値や技能を強化できます。
  - `/delete_character`: キャラクターを削除します。

### ゲームの進行
- **AIによる導入シナリオ**:
  - `/start_game`で冒険を開始すると、AIがあなたのキャラクター設定に基づいた、専用の導入物語を自動で生成します。
- **シームレスな対話形式でのプレイ**:
  - ゲーム用のスレッド内では、`/next`コマンドを打つ必要はありません。通常のチャットのように次に行いたい行動を送信するだけで、AIが応答し物語が進行します。
- **行動を導く選択肢**:
  - AIは物語の応答と共に、次にどのような行動が取れるかのヒントを3つほどのボタンとして提示します。プレイヤーはこのボタンをクリックすることでも行動を簡単に選択できます。
- **ダイナミックな物語生成**:
  - あなたの行動をAIが解釈し、物語の続きや行動の結果をリアルタイムで生成します。状況によっては、AIがダンジョンで「なぞなぞ」や「簡単なパズル」を仕掛けてくることもあります。
- **ゲームの終了**:
  - `/end_game`: 冒険を中断し、キャラクターの成長や世界の変更点をすべて保存してゲームを終了します。
- **特殊なアクション**:
  - `/use`: インベントリ内のアイテム（例：ポーション）を使用し、HPの回復などの効果を得られます。
  - `/next 逃げる`: 戦闘中に「逃げる」と入力することで、戦闘からの離脱を試みることができます。（コマンドレス対話が有効なため、スレッド内で単に「逃げる」と発言することでも実行可能です）

### "生きている世界"を体験する機能
- **共有される世界状態**:
  - あなたの行動によって変化したNPCの友好度などの状態は、サーバー全体で共有され、他のプレイヤーのゲームにも影響を与えます。
- **永続的な墓場システム**:
  - 冒険の途中で力尽きたキャラクターは、その世界の「墓場」に記録されます。
  - `/graveyard`: この世界で散っていった過去の冒険者たちの記録（名前、レベル、死因）を閲覧できます。
  - `/search_grave`: 他のプレイヤーが遺した墓を探索し、そのキャラクターが持っていたアイテムを回収できることがあります。

### 補助機能
- **ゲームログ**:
  - ゲームの開始、進行（プレイヤーの行動とAIの応答）、終了といったすべてのイベントが、指定されたログチャンネルに記録されます。
- **ユーティリティ**:
  - `/help`: 利用可能なコマンドの一覧を表示します。
  - `/ping`: Botの応答速度を確認します。

## 📂 プロジェクト構成

```
AI_TRPG_Fantasy/
├── bot/              # Discordボット関連
│   ├── cogs/         # スラッシュコマンドを機能ごとに分割
│   └── ui/           # EmbedやViewなどのUIコンポーネント
├── game/             # ゲームのコアロジック（Discordに非依存）
│   ├── models/       # Character, Enemy, Sessionなどのデータ構造
│   ├── services/     # ゲームのビジネスロジック
│   └── managers/     # 複数のオブジェクトを管理
├── infrastructure/   # データ保存や外部APIなど技術的な詳細
│   ├── data_loaders/ # 静的データ（世界設定など）の読み込み
│   └── repositories/ # 動的データ（キャラクター、世界状態）の永続化
├── core/             # プロジェクト共通の要素（カスタム例外など）
├── config/           # 設定ファイル
├── game_data/        # ゲームの静的データ（JSONファイル）
└── main.py           # アプリケーションのエントリーポイント
```

## 🚀 セットアップ

1.  **リポジトリをクローンします。**
2.  **Ollamaをセットアップします。**
    - [Ollama](https://ollama.com/) の公式サイトからアプリケーションをダウンロードし、インストールしてください。
    - ターミナルで `ollama run llama3` のようなコマンドを実行し、使用したいモデル（例: `llama3`, `gemma`など）をあらかじめダウンロードしておきます。
3.  **必要なライブラリをインストールします。**
    - ターミナルで以下のコマンドを実行してください。
      ```bash
      pip install discord.py python-dotenv aiofiles openai
      ```
4.  **.env.example** をコピーして **.env** ファイルを作成します。
5.  **.env** ファイル内に、Discord Botのトークンや各種チャンネルIDを設定します。`LOCAL_AI_MODEL_NAME`には、ステップ2でダウンロードしたモデル名を設定してください。
    ```env
    DISCORD_BOT_TOKEN="YOUR_DISCORD_BOT_TOKEN"
    CHAR_SHEET_CHANNEL_ID="YOUR_CHANNEL_ID"
    SCENARIO_LOG_CHANNEL_ID="YOUR_CHANNEL_ID"
    PLAY_LOG_CHANNEL_ID="YOUR_CHANNEL_ID"
    
    # ローカルAI (Ollama) の設定
    LOCAL_AI_BASE_URL="http://localhost:11434/v1"
    LOCAL_AI_MODEL_NAME="llama3"
    ```
6.  **Botを起動します。**
    ```bash
    python main.py
    ```

## 🤖 Botのサーバーへの導入

1.  **Discord Developer Portalにアクセス**:
    - Botのアプリケーションを作成したDiscord Developer Portalにアクセスし、ログインします。

2.  **アプリケーションを選択**:
    - アプリケーションの一覧から、このTRPGボットを選択します。

3.  **URL Generatorを開く**:
    - 左側のメニューから「**OAuth2**」 > 「**URL Generator**」の順にクリックします。

4.  **スコープ (Scopes) を選択**:
    - `bot` と `applications.commands` の2つにチェックを入れます。

5.  **権限 (Bot Permissions) を設定**:
    - 表示された権限リストの中から、Botが動作するために必要な権限にチェックを入れます。少なくとも以下の権限が必要です。
    - **Text Permissions**:
        - `Send Messages` (メッセージを送信)
        - `Send Messages in Threads` (スレッドでメッセージを送信)
        - `Create Private Threads` (プライベートスレッドを作成)
        - `Manage Threads` (スレッドの管理)
        - `Embed Links` (埋め込みリンク)
        - `Read Message History` (メッセージ履歴を読む)

6.  **招待URLを生成してアクセス**:
    - ページ下部に生成されたURLをコピーし、ブラウザでアクセスします。
    - Botを追加したいサーバーを選択し、画面の指示に従って認証を完了させてください。

---

この`README.md`は、プロジェクトの現状を反映したものです。新しい機能が追加された際には、随時更新していくことが推奨されます。